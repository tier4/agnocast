name: comment-coverage

on:
  workflow_run:
    workflows: ["build-and-test-agnocastlib-heaphook"]
    types:
      - completed

permissions:
  pull-requests: write

jobs:
  comment:
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ros_distro: [humble, jazzy]
    steps:
      - name: Download coverage artifact
        id: download
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-${{ matrix.ros_distro }}
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Post coverage comment
        if: steps.download.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          coverage_text=$(<coverage.txt)
          PR_NUMBER=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }} --jq '.pull_requests[0].number')
          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body "$(echo -e '<details>\n<summary>Coverage Report (${{ matrix.ros_distro }})</summary>\n\n```\n'"$coverage_text"'\n```\n</details>')"
          else
            echo "Could not determine PR number, skipping comment"
          fi
