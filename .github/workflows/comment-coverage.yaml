name: comment-coverage

on:
  workflow_run:
    workflows: ["build-and-test-agnocastlib-heaphook"]
    types:
      - completed

permissions:
  actions: read
  pull-requests: write

jobs:
  comment:
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ros_distro: [humble, jazzy]
    steps:
      - name: Check if coverage artifact exists
        id: check_artifact
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ARTIFACT_NAME="coverage-report-${{ matrix.ros_distro }}"
          ARTIFACT_EXISTS=$(gh api "repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts" \
            --jq ".artifacts | map(select(.name == \"$ARTIFACT_NAME\")) | length")
          if [ "$ARTIFACT_EXISTS" -gt 0 ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "Coverage artifact not found (C++ files may not have changed), skipping"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Download coverage artifact
        if: steps.check_artifact.outputs.exists == 'true'
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-${{ matrix.ros_distro }}
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Post coverage comment
        if: steps.check_artifact.outputs.exists == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          coverage_text=$(<coverage.txt)
          PR_NUMBER=$(<pr_number.txt)
          gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body "$(echo -e '<details>\n<summary>Coverage Report (${{ matrix.ros_distro }})</summary>\n\n```\n'"$coverage_text"'\n```\n</details>')"
