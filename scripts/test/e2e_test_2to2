#!/bin/bash

# Signal handling: kill all descendant processes on exit
cleanup() {
    trap - SIGINT SIGTERM SIGHUP
    kill -- -$$ 2>/dev/null
    rm -f "$COMMANDS_FILE" "$WORKER_SCRIPT" 2>/dev/null
    exit 130
}
trap cleanup SIGINT SIGTERM SIGHUP

# Parsing arguments
OPTIONS=$(getopt -o hscp: --long help,single,continue,parallel: -- "$@")
if [ $? -ne 0 ]; then
    echo "Invalid options provided"
    exit 1
fi
eval set -- "$OPTIONS"

usage() {
    echo "Usage: $0 [options]"
    echo "Options:"
    echo "  -h, --help         Show this help message"
    echo "  -s, --single       Run only one test case (Native mode, current config)"
    echo "  -c, --continue     Continue running tests even if one fails"
    echo "  -p, --parallel N   Run tests in parallel with N workers (default: 1 = sequential)"
    exit 0
}

RUN_SINGLE=false
CONTINUE_ON_FAILURE=false
PARALLEL=1
while true; do
    case "$1" in
    -h | --help)
        usage
        ;;
    -s | --single)
        RUN_SINGLE=true
        shift
        ;;
    -c | --continue)
        CONTINUE_ON_FAILURE=true
        shift
        ;;
    -p | --parallel)
        PARALLEL=$2
        CONTINUE_ON_FAILURE=true
        shift 2
        ;;
    --)
        shift
        break
        ;;
    *)
        break
        ;;
    esac
done

# Topic name prefix (can be overridden via E2E_TOPIC_PREFIX)
TOPIC_PREFIX=${E2E_TOPIC_PREFIX:-/test_topic}

# Setup
SKIP_BUILD=${SKIP_BUILD:-false}
if [ "$SKIP_BUILD" != "true" ]; then
    rm -rf build/agnocast_e2e_test install/e2e_test
    source /opt/ros/${ROS_DISTRO}/setup.bash
    colcon build --symlink-install --packages-select agnocast_e2e_test --cmake-args -DCMAKE_BUILD_TYPE=Release
    source install/setup.bash
else
    source /opt/ros/${ROS_DISTRO}/setup.bash
    source install/setup.bash
fi

LOWER_BRIDGE_MODE=$(echo "$AGNOCAST_BRIDGE_MODE" | tr '[:upper:]' '[:lower:]')
CURRENT_BRIDGE_DISPLAY=${LOWER_BRIDGE_MODE:-"standard (default)"}
echo "Bridge mode: $CURRENT_BRIDGE_DISPLAY" | sudo tee /dev/kmsg

# Run test
CONFIG_FILE=src/agnocast_e2e_test/test/config_test_2to2.yaml
show_config() {
    echo "----------------------------------------------" | sudo tee /dev/kmsg
    echo "Test Mode: $TEST_MODE" | sudo tee /dev/kmsg
    cat $CONFIG_FILE | sudo tee /dev/kmsg
    echo "----------------------------------------------" | sudo tee /dev/kmsg
}

# Generate test ID from mode and layout (ROS2 topic-name safe: no hyphens)
# Example: agno2agno_PP_SS (containers separated by underscore)
generate_test_id() {
    local mode=$1
    local layout=$2
    local layout_id="${layout//|/_}"
    echo "${mode}_layout_${layout_id}"
}

FAILURE_COUNT=0
if [ "$RUN_SINGLE" = true ]; then
    CURRENT_YAML_MODE=$(grep "^test_mode:" "$CONFIG_FILE" | awk '{print $2}' | tr -d '"')
    export TEST_MODE=${CURRENT_YAML_MODE}
    show_config
    launch_test src/agnocast_e2e_test/test/test_2to2.py test_mode:="$TEST_MODE"
    if [ $? -ne 0 ]; then
        echo "Test failed" | sudo tee /dev/kmsg
        exit 1
    fi
elif [ "$PARALLEL" -gt 1 ]; then
    # ===== Parallel execution mode =====
    TEST_MODES=("agno2agno" "ros2agno" "agno2ros")
    if [ "$LOWER_BRIDGE_MODE" = "0" ] || [ "$LOWER_BRIDGE_MODE" = "off" ]; then
        TEST_MODES=("agno2agno")
    fi
    CONTAINER_LAYOUT=("PPSS" "PP|SS" "P|PSS" "PPS|S" "P|P|SS" "P|PS|S" "PP|S|S" "P|P|S|S")

    TOTAL_TESTS=$((${#TEST_MODES[@]} * ${#CONTAINER_LAYOUT[@]}))

    LOG_DIR="/tmp/e2e_2to2_logs"
    rm -rf "$LOG_DIR"
    mkdir -p "$LOG_DIR"

    FAILED_TESTS_FILE=$(mktemp)

    # Generate all test commands (with sequential worker number for ROS_DOMAIN_ID)
    COMMANDS_FILE=$(mktemp)
    WORKER_NUM=0
    # Base domain ID offset to avoid collision with default domain (0) and other users
    DOMAIN_ID_BASE=${ROS_DOMAIN_ID_BASE:-10}
    for mode in "${TEST_MODES[@]}"; do
        for layout in "${CONTAINER_LAYOUT[@]}"; do
            TEST_ID=$(generate_test_id "$mode" "$layout")
            echo "$WORKER_NUM $TEST_ID $mode $layout" >> "$COMMANDS_FILE"
            WORKER_NUM=$((WORKER_NUM + 1))
        done
    done

    echo "Running $TOTAL_TESTS tests with $PARALLEL parallel workers..." | sudo tee /dev/kmsg

    # Export variables needed by worker
    export TOPIC_PREFIX LOG_DIR FAILED_TESTS_FILE DOMAIN_ID_BASE

    # Create worker script
    WORKER_SCRIPT=$(mktemp /tmp/e2e_2to2_worker_XXXXXX.sh)
    cat > "$WORKER_SCRIPT" << 'WORKER_EOF'
#!/bin/bash
WORKER_NUM=$1
TEST_ID=$2
mode=$3
layout=$4

# Isolate DDS discovery per worker
export ROS_DOMAIN_ID=$((DOMAIN_ID_BASE + WORKER_NUM))

CONFIG_TMP="/tmp/e2e_2to2_${TEST_ID}.yaml"

# Parse layout into container configs
IFS='|' read -ra containers <<< "$layout"
{
    echo "test_mode: \"$mode\""
    for i in {0..3}; do
        if [ "$i" -lt "${#containers[@]}" ]; then
            list=$(echo "${containers[$i]}" | sed 's/./\L&,/g; s/,$//')
        else
            list=""
        fi
        echo "container$i: [$list]"
    done
} > "$CONFIG_TMP"

LOG_FILE="${LOG_DIR}/${TEST_ID}.log"
export TEST_MODE=$mode
E2E_TOPIC_NAME="${TOPIC_PREFIX}_${TEST_ID}" E2E_CONFIG_PATH="$CONFIG_TMP" launch_test src/agnocast_e2e_test/test/test_2to2.py test_mode:=$mode > "$LOG_FILE" 2>&1
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    echo "FAILED: $TEST_ID" >&2
    echo "$TEST_ID" >> "$FAILED_TESTS_FILE"
else
    echo "PASSED: $TEST_ID"
fi

rm -f "$CONFIG_TMP"
sleep 2
WORKER_EOF
    chmod +x "$WORKER_SCRIPT"

    # Run tests in parallel with job control
    RUNNING_JOBS=0
    while IFS= read -r line; do
        # shellcheck disable=SC2086
        bash "$WORKER_SCRIPT" $line &
        RUNNING_JOBS=$((RUNNING_JOBS + 1))
        if [ "$RUNNING_JOBS" -ge "$PARALLEL" ]; then
            wait -n
            RUNNING_JOBS=$((RUNNING_JOBS - 1))
        fi
    done < "$COMMANDS_FILE"
    wait

    rm -f "$COMMANDS_FILE" "$WORKER_SCRIPT"

    # Summary
    if [ -s "$FAILED_TESTS_FILE" ]; then
        FAILURE_COUNT=$(wc -l < "$FAILED_TESTS_FILE")
        echo "" | sudo tee /dev/kmsg
        echo "====== FAILURE SUMMARY ======" | sudo tee /dev/kmsg
        echo "$FAILURE_COUNT / $TOTAL_TESTS tests failed:" | sudo tee /dev/kmsg
        while IFS= read -r test_id; do
            echo "  FAILED: $test_id (log: ${LOG_DIR}/${test_id}.log)" | sudo tee /dev/kmsg
        done < "$FAILED_TESTS_FILE"
        echo "=============================" | sudo tee /dev/kmsg
        rm -f "$FAILED_TESTS_FILE"
        exit 1
    else
        echo "All $TOTAL_TESTS tests passed!!" | sudo tee /dev/kmsg
        rm -f "$FAILED_TESTS_FILE"
    fi
else
    # ===== Sequential execution mode (original behavior) =====
    TEST_MODES=("agno2agno" "ros2agno" "agno2ros")
    if [ "$LOWER_BRIDGE_MODE" = "0" ] || [ "$LOWER_BRIDGE_MODE" = "off" ]; then
        TEST_MODES=("agno2agno")
    fi
    CONTAINER_LAYOUT=("PPSS" "PP|SS" "P|PSS" "PPS|S" "P|P|SS" "P|PS|S" "PP|S|S" "P|P|S|S")

    TOTAL_TESTS=$((${#TEST_MODES[@]} * ${#CONTAINER_LAYOUT[@]}))
    CURRENT_COUNT=0

    for mode in "${TEST_MODES[@]}"; do
        export TEST_MODE=$mode
        sed -i "s|^test_mode:.*|test_mode: \"$mode\"|" "$CONFIG_FILE"

        for layout in "${CONTAINER_LAYOUT[@]}"; do
            CURRENT_COUNT=$((CURRENT_COUNT + 1))

            IFS='|' read -ra containers <<<"$layout"
            for i in {0..3}; do # 4 containers
                if [ "$i" -lt "${#containers[@]}" ]; then
                    list=$(echo "${containers[$i]}" | sed 's/./\L&,/g; s/,$//') # PPSS" -> "p,p,s,s"
                else
                    list=""
                fi
                sed -i "s|^container$i:.*|container$i: [$list]|" "$CONFIG_FILE"
            done

            echo "====================== $CURRENT_COUNT / $TOTAL_TESTS (Mode: $mode) ======================" | sudo tee /dev/kmsg
            show_config
            launch_test src/agnocast_e2e_test/test/test_2to2.py test_mode:=$mode

            if [ $? -ne 0 ]; then
                echo "Test failed at Mode: $mode, Layout: $layout" | sudo tee /dev/kmsg
                if [ "$CONTINUE_ON_FAILURE" = true ]; then
                    FAILURE_COUNT=$((FAILURE_COUNT + 1))
                else
                    exit 1
                fi
            fi
            # Add a 2s safety margin to account for bridge cleanup (expected max ~1s).
            sleep 2
        done
    done

    if [ "$FAILURE_COUNT" -gt 0 ]; then
        echo "$FAILURE_COUNT / $TOTAL_TESTS tests failed" | sudo tee /dev/kmsg
        exit 1
    else
        echo "All tests passed!!" | sudo tee /dev/kmsg
    fi

    # Reset config file
    git checkout -- "$CONFIG_FILE"
fi
